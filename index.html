<!DOCTYPE html>
<html lang="en">
<head>
  	<!--<link rel="shortcut icon" type="image/x-icon" href="icon.png">-->
  	<title>EHR Data Visualization</title>
  	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  	<link type="text/css" rel="stylesheet" media="all" href="css/style.css" />
</head>
<body>
	<div class="filters">
		<div id="chronic">
			<div class="btn" id="chronbtn">Chronic Illnesses</div>
			<div class="filtercontent" id="chroncontent">
				<input type="checkbox" name="cancer" /> cancer <br/>
				<input type="checkbox" name="COPD" /> COPD <br/>
				<input type="checkbox" name="osteo" /> osteo <br/>
				<input type="checkbox" name="ischemicHeart"/> ischemicHeart <br/>
				<input type="checkbox" name="arthritis" /> arthritis <br/>
				<input type="checkbox" name="heartFailure" /> heartFailure <br/>
				<input type="checkbox" name="alzheimers" /> alzheimers <br/>
				<input type="checkbox" name="stroke" /> stroke <br/>
				<input type="checkbox" name="kidney" /> kidney <br/>
				<input type="checkbox" name="depression" /> depression <br/>
				<input type="checkbox" name="diabetes" /> diabetes <br/>
			</div>
		</div>
		<div id="diagnosis">
			<div class="btn" id="diagnosisbtn">Diagnosis</div>
			<div class="filtercontent" id="diagcontent"></div>
		</div>
		<div id="procedures">
			<div class="btn" id="procbtn">Procedures</div>
			<div class="filtercontent" id="proccontent"></div>
		</div>
		<hr/>
		<div class="nodeinfo"></div>
	</div>
	<div class="graphwrap"></div>

    <script type="text/javascript">
	//Width and height
	var w = window,
	d = document,
	e = d.documentElement,
	g = d.getElementsByClassName('graphwrap')[0],
	p = {top:0,left:5,bottom:0,right:5},
	m = {top: 0, right: 0, bottom: 20, left: 0},
    w = (g.clientWidth) - p.left - p.right - m.left - m.right,
    h = 750 - m.top - m.bottom;
    var padding = 60;
	var radius = 6;

	var dataset = []

	var color = ['rgb(255,255,229)','rgb(255,247,188)','rgb(254,227,145)','rgb(254,196,79)','rgb(254,153,41)','rgb(236,112,20)','rgb(204,76,2)','rgb(153,52,4)','rgb(102,37,6)'];

	var chronicdata = [];
	var diagdata = [];

	d3.json("data/outpatient.json", function(error, json) {
		if (error){ return console.warn(error); }

		d3.json("data/CHRONoutpatient.json", function(chronerror,chronjson) {
			if (chronerror){ return console.warn(error); }

			chronicdata = chronjson;
			var dataset = json;

			console.log("outpatient count = " + d3.keys(dataset).length)
			console.log("CHRONoutpatient count = " + d3.keys(chronicdata).length)

			diagdata = dataset;

			var all_codes = d3.keys(dataset);

			//console.log(all_codes);
			//console.log(dataset);
			//console.log(chronicdata);

			var max_x = d3.max(all_codes, function(d) { return dataset[d]['unique_patients'] / dataset[d]['overall_uniques']; });
			var max_y = d3.max(all_codes, function(d) { return (dataset[d]['total_costs'] / dataset[d]['total_visits']); });

			//Create glyph scale functions
			/*
			var x = d3.scale.linear()
			    .range([0, 2 * Math.PI]);

			var y = d3.scale.sqrt()
			    .range([0, radius]);

			var arc = d3.svg.arc()
			    .outerRadius(radius)
			    .innerRadius(0);

			var pie = d3.layout.pie()
			    .sort(null)
			    .value(function(d){return d.value;});
			*/

			//Create scale functions
			var xScale = d3.scale.pow().exponent(0.3)
			.domain([0, max_x])
			.range([padding, w - padding * 2]);

			var yScale = d3.scale.pow().exponent(0.6)
			.domain([0, max_y])
			.range([h - padding, padding]);

			//Define X axis
			var xAxis = d3.svg.axis()
			.scale(xScale)
			.orient("bottom")
			.ticks(5);

			//Define Y axis
			var yAxis = d3.svg.axis()
			.scale(yScale)
			.orient("left")
			.ticks(5);

			//Create SVG element
			var svg = d3.select(".graphwrap")
			.append("svg")
			.attr("width", w)
			.attr("height", h)
			.call(d3.behavior.zoom().x(xScale).y(yScale).scaleExtent([1, 30]).on("zoom", zoom));

			//Create circles
			all_codes.forEach(function(d){
				//HARD FILTERS
				if(dataset[d]['unique_patients']/dataset[d]['overall_uniques'] > 0.000001){
					//LOAD FILTERS
					$('#diagcontent').append('<input type="checkbox" name="' + d + '" checked>' + d + '<br>');

					var code = d;

					/*
					var chronicKeys = d3.keys(chronicdata[code]);
					var glyphdata = [{"label":"sel", "value":0},{"label":"else","value":0}];

					chronicKeys.forEach(function(cd){
						if(cd != "uniques" && cd != "total_visits"){
							if(selectedChronics.indexOf(cd) != -1){
								glyphdata[0]['value'] += chronicdata[code][cd]
							}else{
								glyphdata[1]['value'] += chronicdata[code][cd]
							}
						}
					});

					if(!(glyphdata[0]['value'] == 0 && glyphdata[1]['value'] == 0)){
					*/

						//var distrib = (glyphdata[0]['value'] / (glyphdata[0]['value'] + glyphdata[1]['value']));

						//var colorsect = color[Math.round(distrib * 8)];

						var nodegroup = svg.append("g").classed("nodegroup",true)
							.on("click",nodeclick);

						nodegroup.append("circle")
						.attr("icd9",d)
						.attr("cx",function(){
							return xScale(dataset[d]['unique_patients']/dataset[d]['overall_uniques'])
						})
						.attr("cy",function(){
							return yScale(dataset[d]['total_costs'] / dataset[d]['total_visits']);
						})
						.attr("r",radius)
						.style("fill",color[4])
						.style("stroke",'#fff');

						nodegroup.append("text")
						.html("Diagnosis: " + code + "<br />Frequency: " + dataset[code]['unique_patients']/dataset[code]['overall_uniques'] + "<br />Cost: $" + dataset[code]['total_costs'] / dataset[code]['total_visits'])
						.attr("x", 20)
						.attr("y", 20)
						.style('display','none');
					//}
				}
				/*
				//HARD FILTERS
				if(dataset[d]['unique_patients']/dataset[d]['overall_uniques'] > 0.00001){
					//LOAD FILTERS
					$('#diagcontent').append('<input type="checkbox" name="' + d + '" checked>' + d + '<br>');

					if(dataset[d]['total_costs'] / dataset[d]['total_visits'] < 0){
						console.log(d);
						console.log(dataset[d]);
					}

					var code = d;
					var glyphdata = [{"label":"sel", "value":0},{"label":"else","value":0}];

					var selectedChronics = ['ischemicHeart']; //DYMANIC CHRONIC ILLNESS SELECT

					var chronicKeys = d3.keys(chronicdata[code]);

					chronicKeys.forEach(function(cd){
						if(cd != "uniques" && cd != "total_visits"){
							if(selectedChronics.indexOf(cd) != -1){
								glyphdata[0]['value'] += chronicdata[code][cd]
							}else{
								glyphdata[1]['value'] += chronicdata[code][cd]
							}
						}
					});

					if(!(glyphdata[0]['value'] == 0 && glyphdata[1]['value'] == 0)){

						var xtrans =  xScale(dataset[code]['unique_patients']/dataset[code]['overall_uniques']);

						var ytrans = yScale(dataset[code]['total_costs'] / dataset[code]['total_visits']);

						var glyphgroup = svg.append("g")
						    .attr("transform", "translate(" + xtrans + "," + ytrans + ")")
						.on("click",nodeclick);

						
						glyphgroup.append("text")
						.html("Diagnosis: " + code + "<br />Frequency: " + dataset[code]['unique_patients']/dataset[code]['overall_uniques'] + "<br />Cost: $" + dataset[code]['total_costs'] / dataset[code]['total_visits'])
						.attr("x", 20)
						.attr("y", 20)
						.style('display','none');
						

						var glyph = glyphgroup.selectAll(".arc")
						.data(pie(glyphdata))
						.enter().append("g")
						.attr("class",function(e){ return e.data.label + " slice"})
						.attr("value",function(e){ return e.data.value})
						.style("cursor","pointer")
						.style("opacity","0.8");

						var path = glyph.append("path")
						.attr('x','0')
						.attr('y','0')
						.attr('width','100%')
						.attr('height','100%')
						.attr("d", arc)
						.style("fill", function(d){ return color[d.data.label]; })
						//.style("fill","url(#diagonal)")
						.style("stroke","#fff")
						//.style("stroke-width","2");
					}
				}
				*/
			});

			//Create X axis
			svg.append("g")
			.attr("class", "x axis")
			.attr("transform", "translate(0," + (h - padding) + ")")
			.call(xAxis);

			//Create Y axis
			svg.append("g")
			.attr("class", "y axis")
			.attr("transform", "translate(" + padding + ",0)")
			.call(yAxis);

			svg.append("text")
			.classed("axistext",true)
			.attr("x", w/2)
			.attr("y", h-10)
			.text("Frequency");

			svg.append("text")
			.classed("axistext",true)
			.attr("transform", "rotate(-90)")
			.attr("y",0)
			.attr("x",-(h/2))
			.attr("dy", "1em")
			.style("text-anchor", "middle")
			.text("Average Cost ($)");


			function zoom() {
				svg.select(".x.axis").call(xAxis);
	  			svg.select(".y.axis").call(yAxis);

	  			svg.selectAll("circle")
				.attr("cx", function() {
					code = d3.select(this).attr("icd9");
					return xScale(dataset[code]['unique_patients']/dataset[code]['overall_uniques']);
				})
				.attr("cy", function(){
					code = d3.select(this).attr("icd9");
					return yScale(dataset[code]['total_costs'] / dataset[code]['total_visits']);
				});
			}
		});
	});

	function nodeclick(){
		var group = d3.select(this);

		if(group.classed('selected')){
			group.select('text').style('opacity',0);

			var circle = group.select('circle');

			circle.attr("r",6);

			group.classed('selected',false);

			/*
			var arcOver = d3.svg.arc()
			    .outerRadius(radius)
			    .innerRadius(0);

			arc.selectAll("path").transition()
				.duration(500)
				.attr("d", arcOver)
				.style("opacity","0.8");
			*/
		}else{
			var text = group.select('text').html();

			group.classed('selected', true);

			var circle = group.select('circle');

			circle.attr("r",24);

			/*
			var arcOver = d3.svg.arc()
		        .outerRadius(4*radius)
		        .innerRadius(0);

			var value = arc.attr("value");

			arc.selectAll("path").transition()
				.duration(500)
				.attr("d", arcOver)
				.style("opacity","1");
			*/

			var nodeinfo = d3.select(".nodeinfo");

			nodeinfo.html(text);
		}
	}

	function loadColors(selectedChronics){
		console.log("loadcolors");
		console.log(chronicdata);

		d3.select("svg").selectAll("circle")
		.style("fill", function(){
			d3.select(this).style("display","");

			code = d3.select(this).attr("icd9");
			var chronicKeys = d3.keys(chronicdata[code]);
			var glyphdata = [{"label":"sel", "value":0},{"label":"else","value":0}];

			chronicKeys.forEach(function(cd){
				if(cd != "uniques" && cd != "total_visits"){
					if(selectedChronics.indexOf(cd) != -1){
						glyphdata[0]['value'] += chronicdata[code][cd]
					}else{
						glyphdata[1]['value'] += chronicdata[code][cd]
					}
				}
			});

			if(glyphdata[0]['value'] != 0){
				var distrib = (glyphdata[0]['value'] / (glyphdata[0]['value'] + glyphdata[1]['value']));

				var colorsect = color[Math.round(distrib * 8)];	
				
				return colorsect;			
			}else{
				d3.select(this).style("display","none");
				//console.log(code);
				//console.log(chronicdata[code]);
				//console.log(diagdata[code]);
				//return color[0];
			}
		});
	}

  	$(document).ready(function(){
		$('#chroncontent').slideUp(0);
		$('#diagcontent').slideUp(0);
		$('#proccontent').slideUp(0);
	});

	$(document).on("click","#chronbtn",function(){
		$("#chroncontent").slideToggle();
	});

	$(document).on("click","#diagnosisbtn",function(){
		$("#diagcontent").slideToggle();
	});

	$(document).on("change","#chroncontent input",function(){
		var selectedChronics = [];
		$("#chroncontent input").each(function(c){
			var c = $(this);
			//console.log($(this).attr('name'));
			if(c.prop( "checked" )){
				selectedChronics.push(c.attr("name"));
			}
		});

		loadColors(selectedChronics);
	})
    </script>
  </body>
</html>