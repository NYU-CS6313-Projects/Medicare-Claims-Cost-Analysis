<!DOCTYPE html>
<html lang="en">
<head>
  	<!--<link rel="shortcut icon" type="image/x-icon" href="icon.png">-->
  	<title>EHR Data Visualization</title>
  	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  	<link type="text/css" rel="stylesheet" media="all" href="css/style.css" />
</head>
<body>
	<div class="filters">
		<div id="chronic">
			<div class="btn" id="chronbtn">Chronic Illnesses</div>
			<div class="filtercontent" id="chroncontent">
				<input type="checkbox" name="cancer" /> cancer <br/>
				<input type="checkbox" name="COPD" /> COPD <br/>
				<input type="checkbox" name="osteo" /> osteo <br/>
				<input type="checkbox" name="ischemicHeart" checked/> ischemicHeart <br/>
				<input type="checkbox" name="arthritis" /> arthritis <br/>
				<input type="checkbox" name="heartFailure" /> heartFailure <br/>
				<input type="checkbox" name="alzheimers" /> alzheimers <br/>
				<input type="checkbox" name="stroke" /> stroke <br/>
				<input type="checkbox" name="kidney" /> kidney <br/>
				<input type="checkbox" name="depression" /> depression <br/>
				<input type="checkbox" name="diabetes" /> diabetes <br/>
			</div>
		</div>
		<div id="diagnosis">
			<div class="btn" id="diagnosisbtn">Diagnosis</div>
			<div class="filtercontent" id="diagcontent"></div>
		</div>
		<div id="procedures">
			<div class="btn" id="procbtn">Procedures</div>
			<div class="filtercontent" id="proccontent"></div>
		</div>
		<hr/>
		<div class="nodeinfo"></div>
	</div>
	<div class="graphwrap"></div>

    <script type="text/javascript">
	//Width and height
	var w = window,
	d = document,
	e = d.documentElement,
	g = d.getElementsByClassName('graphwrap')[0],
	p = {top:0,left:5,bottom:0,right:5},
	m = {top: 0, right: 0, bottom: 20, left: 0},
    w = (g.clientWidth) - p.left - p.right - m.left - m.right,
    h = 750 - m.top - m.bottom;
    var padding = 60;
	var radius = 6;

	var dataset = []

	d3.json("old_files/outpatient.json", function(error, json) {
		if (error){ return console.warn(error); }

		d3.json("data/CHRONoutpatient.json", function(chronerror,chronjson) {
		if (chronerror){ return console.warn(error); }

		chronicdata = chronjson;
		dataset = json;
		var all_codes = d3.keys(dataset);
		//var color = {"sel":"#0aa2bd", "else":"#ffd800"};
		var color = {"sel":"#000", "else":"#ffd800"};

		//console.log(all_codes);
		//console.log(dataset);
		console.log(chronicdata);

		//Create glyph scale functions
		var x = d3.scale.linear()
		    .range([0, 2 * Math.PI]);

		var y = d3.scale.sqrt()
		    .range([0, radius]);

		var arc = d3.svg.arc()
		    .outerRadius(radius)
		    .innerRadius(0);

		var pie = d3.layout.pie()
		    .sort(null)
		    .value(function(d){return d.value;});

		//Create scale functions
		var xScale = d3.scale.pow().exponent(0.3)
		.domain([0, d3.max(all_codes, function(d) { return dataset[d]['unique_patients']/dataset[d]['overall_uniques']; })])
		.range([padding, w - padding * 2]);

		var yScale = d3.scale.pow().exponent(0.6)
		.domain([0, d3.max(all_codes, function(d) { return (dataset[d]['total_costs'] / dataset[d]['total_visits']); })])
		.range([h - padding, padding]);

		//Define X axis
		var xAxis = d3.svg.axis()
		.scale(xScale)
		.orient("bottom")
		.ticks(5);

		//Define Y axis
		var yAxis = d3.svg.axis()
		.scale(yScale)
		.orient("left")
		.ticks(5);

		var zoom = d3.behavior.zoom()
		.x(xScale)
		.y(yScale)
		.scaleExtent([1, 4])
		.on("zoom", zoomed);

		//Create SVG element
		var svg = d3.select(".graphwrap")
		.append("svg")
		.attr("width", w)
		.attr("height", h)
		.append("g")
			.attr("transform","translate(" + m.left + "," + m.top + ")")
			.call(zoom);

		//Create circles
		all_codes.forEach(function(d){
			//HARD FILTERS
			if(dataset[d]['unique_patients']/dataset[d]['overall_uniques'] > 0.00001){
				//LOAD FILTERS
				$('#diagcontent').append('<input type="checkbox" name="' + d + '" checked>' + d + '<br>');

				if(dataset[d]['total_costs'] / dataset[d]['total_visits'] < 0){
					console.log(d);
					console.log(dataset[d]);
				}

				var code = d;
				var glyphdata = [{"label":"sel", "value":0},{"label":"else","value":0}];

				var selectedChronics = ['ischemicHeart']; //DYMANIC CHRONIC ILLNESS SELECT

				var chronicKeys = d3.keys(chronicdata[code]);

				chronicKeys.forEach(function(cd){
					if(cd != "uniques" && cd != "total_visits"){
						if(selectedChronics.indexOf(cd) != -1){
							glyphdata[0]['value'] += chronicdata[code][cd]
						}else{
							glyphdata[1]['value'] += chronicdata[code][cd]
						}
					}
				});

				if(!(glyphdata[0]['value'] == 0 && glyphdata[1]['value'] == 0)){

					var xtrans =  xScale(dataset[code]['unique_patients']/dataset[code]['overall_uniques']);

					var ytrans = yScale(dataset[code]['total_costs'] / dataset[code]['total_visits']);

					var glyphgroup = svg.append("g")
					    .attr("transform", "translate(" + xtrans + "," + ytrans + ")")
					.on("click",nodeclick);

					
					glyphgroup.append("text")
					.html("Diagnosis: " + code + "<br />Frequency: " + dataset[code]['unique_patients']/dataset[code]['overall_uniques'] + "<br />Cost: $" + dataset[code]['total_costs'] / dataset[code]['total_visits'])
					.attr("x", 20)
					.attr("y", 20)
					.style('display','none');
					

					var glyph = glyphgroup.selectAll(".arc")
					.data(pie(glyphdata))
					.enter().append("g")
					.attr("class",function(e){ return e.data.label + " slice"})
					.attr("value",function(e){ return e.data.value})
					.style("cursor","pointer")
					.style("opacity","0.8");

					var path = glyph.append("path")
					.attr('x','0')
					.attr('y','0')
					.attr('width','100%')
					.attr('height','100%')
					.attr("d", arc)
					.style("fill", function(d){ return color[d.data.label]; })
					//.style("fill","url(#diagonal)")
					.style("stroke","#fff")
					//.style("stroke-width","2");
				}
			}
		});
		

		//Create X axis
		svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + (h - padding) + ")")
		.call(xAxis);

		//Create Y axis
		svg.append("g")
		.attr("class", "y axis")
		.attr("transform", "translate(" + padding + ",0)")
		.call(yAxis);

		svg.append("text")
		.attr("x", w/2)
		.attr("y", h-10)
		.text("Frequency");

		svg.append("text")
		.attr("transform", "rotate(-90)")
		.attr("y",0)
		.attr("x",-(h/2))
		.attr("dy", "1em")
		.style("text-anchor", "middle")
		.text("Average Cost ($)");
		});

		function zoomed() {
			d3.select(".x.axis").call(xAxis);
  			d3.select(".y.axis").call(yAxis);
		}
	});

	function nodeclick(){
		var arc = d3.select(this);

		if(arc.classed('selected')){
			arc.select('text').style('opacity',0);

			var arcOver = d3.svg.arc()
			    .outerRadius(radius)
			    .innerRadius(0);

			arc.classed('selected',false);

			arc.selectAll("path").transition()
				.duration(500)
				.attr("d", arcOver)
				.style("opacity","0.8");
		}else{
			var text = arc.select('text').html();

			var arcOver = d3.svg.arc()
		        .outerRadius(4*radius)
		        .innerRadius(0);

		    arc.classed('selected', true);

			var value = arc.attr("value");

			arc.selectAll("path").transition()
				.duration(500)
				.attr("d", arcOver)
				.style("opacity","1");

			var nodeinfo = d3.select(".nodeinfo");

			nodeinfo.html(text);
		}
	}

  	$(document).ready(function(){
		$('#chroncontent').slideUp(0);
		$('#diagcontent').slideUp(0);
		$('#proccontent').slideUp(0);
	});

	$(document).on("click","#chronbtn",function(){
		$("#chroncontent").slideToggle();
	});

	$(document).on("click","#diagnosisbtn",function(){
		$("#diagcontent").slideToggle();
	});
    </script>
  </body>
</html>